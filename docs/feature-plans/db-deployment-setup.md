# Multi-Environment Database Deployment Setup

## Overview

This document outlines the multi-environment deployment strategy for ClassFlow, ensuring safe database migration testing and deployment across Development, Staging, and Production environments.

## Environment Architecture

### Three Supabase Projects

1. **Development (Lovable Preview)**
   - **Purpose**: Active development and testing
   - **Project URL**: `https://wkfgcroybuuefaulqsru.supabase.co`
   - **Project ID**: `wkfgcroybuuefaulqsru`
   - **Access**: Hardcoded in `.env.development` (committed to Git)
   - **Usage**: Default for `npm run dev` in Lovable

2. **Staging (Vercel Deployment)**
   - **Purpose**: Pre-production testing and migration validation
   - **Project URL**: `https://pnmzjmcfeekculqyirpr.supabase.co`
   - **Project ID**: `pnmzjmcfeekculqyirpr`
   - **Access**: Hardcoded in `.env.staging` (committed to Git)
   - **Usage**: Vercel staging deployment for QA

3. **Production (Hostinger via Git)**
   - **Purpose**: Live production environment
   - **Project URL**: `https://dqsegqxnnhowqjxifhej.supabase.co`
   - **Project ID**: `dqsegqxnnhowqjxifhej`
   - **Access**: Hardcoded in `.env.production` (committed to Git)
   - **Usage**: Hostinger production build

## Security Model

### What's Safe to Commit

âœ… **Committed to Git** (Public-Safe):

- Supabase Project URLs
- Supabase Anon/Public Keys
- Supabase Project IDs

**Rationale**: These credentials are designed to be public-facing. Security is enforced through:

- Row Level Security (RLS) policies on database tables
- Supabase Auth for user authentication
- API rate limiting

### What Must Stay Secret

âŒ **NEVER Commit**:

- Service Role Keys (bypass RLS)
- Database passwords
- Private API keys
- `.env.local` (developer overrides)

## File Structure

```txt
project-root/
â”œâ”€â”€ .env.development      # Dev Supabase (committed)
â”œâ”€â”€ .env.staging         # Staging Supabase (committed)
â”œâ”€â”€ .env.production      # Production Supabase (committed)
â”œâ”€â”€ .env.local           # Local overrides (gitignored)
â”œâ”€â”€ .env.example         # Template for reference
â””â”€â”€ .gitignore           # Excludes .env.local
```

## Supabase Client Consolidation

### Single Source of Truth

**Primary Client**: `src/lib/supabase.ts`

- Reads from environment variables
- Used by ~45 files across the codebase
- Dynamically selects Supabase project based on `VITE_APP_ENV`

### Deprecated Client

**Legacy Client**: `src/integrations/supabase/client.ts`

- Auto-generated by Lovable Supabase integration
- Marked as deprecated with console warning
- Will be re-edited by future Lovable integration updates
- Currently used by 4 service files (being migrated)

### Migration Status

**Files Updated to Use `src/lib/supabase.ts`**:

- âœ… `src/contexts/__supabaseClient__.ts`
- âœ… `src/features/auth/services/authService.ts`
- âœ… `src/features/programs/services/programsService.ts`
- âœ… `src/features/departments/services/departmentsService.ts`

## Development Workflow

### Local Development (Lovable)

1. **Environment**: Development Supabase
2. **Command**: `npm run dev` (default)
3. **Preview**: Lovable's live preview pane
4. **Database**: Direct connection to Dev Supabase project

**Migration Testing Flow**:

```bash
# Test migration locally
npm run dev
# Verify in Lovable preview
# Commit migration SQL file
git add supabase/migrations/
git commit -m "feat(db): add new table"
```

### Staging Deployment (Vercel)

1. **Environment**: Staging Supabase
2. **Trigger**: Push to `staging` branch or manual deploy
3. **Command**: `npm run build:staging`
4. **URL**: Vercel staging URL (e.g., `classflow-staging.vercel.app`)

**Purpose**:

- QA testing with production-like environment
- Migration validation before production
- Stakeholder demos

**Vercel Project Setup**:

- **Project Name**: `classflow-staging`
- **Framework**: Vite
- **Build Command**: `npm run build:staging`
- **Output Directory**: `dist`
- **Environment Variables**: Automatically read from `.env.staging` (committed)

### Production Deployment (Hostinger)

1. **Environment**: Production Supabase
2. **Trigger**: Push to `master` branch
3. **Build Command**: `npm run build:prod` (Hostinger auto-build)
4. **Domain**: Production domain (e.g., `classflowapp.com`)

**Hostinger Git Integration**:

- Monitors `master` branch
- Auto-builds on push
- Reads `.env.production` from repository

## Migration Testing Strategy

### Step-by-Step Workflow

```txt
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. DEVELOPMENT (Lovable + Dev Supabase)                     â”‚
â”‚    - Write migration SQL                                    â”‚
â”‚    - Test in Lovable preview                                â”‚
â”‚    - Verify RLS policies                                    â”‚
â”‚    - Commit migration file                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. STAGING (Vercel + Staging Supabase)                      â”‚
â”‚    - Push to 'staging' branch                               â”‚
â”‚    - Vercel auto-deploys                                    â”‚
â”‚    - Run QA tests                                           â”‚
â”‚    - Validate with realistic data                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. PRODUCTION (Hostinger + Production Supabase)             â”‚
â”‚    - Merge 'staging' â†’ 'master                              â”‚
â”‚    - Hostinger auto-deploys                                 â”‚
â”‚    - Monitor production metrics                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Migration Execution

**Option A: Automatic (Recommended)**

- Supabase CLI detects new migration files in `supabase/migrations/`
- Auto-applies to connected project on next deployment
- **Staging**: Applied when Vercel builds
- **Production**: Applied when Hostinger builds

**Option B: Manual (Explicit Control)**

```bash
# Apply to Staging
npx supabase db push --db-url "postgresql://postgres.pnmzjmcfeekculqyirpr:[password]@aws-1-ap-southeast-1.pooler.supabase.com:6543/postgres"

# Apply to Production (after staging validation)
npx supabase db push --db-url "postgresql://postgres.wkfgcroybuuefaulqsru:[password]@aws-1-ap-southeast-1.pooler.supabase.com:6543/postgres"
```

## NPM Scripts

### Development

```bash
npm run dev              # Start Vite dev server (uses .env.development)
npm run build:dev        # Build for development environment
```

### Staging

```bash
npm run build:staging    # Build for Vercel staging (uses .env.staging)
npm run preview:staging  # Preview staging build locally
```

### Production

```bash
npm run build:prod       # Build for Hostinger production (uses .env.production)
npm run preview:prod     # Preview production build locally
```

### Database Backups

```bash
npm run backup:dev       # Backup Dev Supabase schema + data
npm run backup:staging   # Backup Staging Supabase schema + data
npm run backup:prod      # Backup Production Supabase schema + data
```

## Environment Variables Reference

### `.env.development` (Dev Supabase)

```env
VITE_SUPABASE_URL=https://dqsegqxnnhowqjxifhej.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxc2VncXhubmhvd3FqeGlmaGVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyMzc1MzIsImV4cCI6MjA3NzgxMzUzMn0.hJKw731wyZHI8Py4LU0AgT2JKI5shenczB83jo4paT0
VITE_APP_ENV=development
```

### `.env.staging` (Staging Supabase)

```env
VITE_SUPABASE_URL=https://pnmzjmcfeekculqyirpr.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBubXpqbWNmZWVrY3VscXlpcnByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MzQxNDQsImV4cCI6MjA3OTAxMDE0NH0.QTyH2jCzAt-wxqiNKG6xcwILo_zZUrnJknfjcsp28oo
VITE_APP_ENV=staging
```

### `.env.production` (Production Supabase)

```env
VITE_SUPABASE_URL=https://wkfgcroybuuefaulqsru.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrZmdjcm95YnV1ZWZhdWxxc3J1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MjgxNzEsImV4cCI6MjA3OTAwNDE3MX0.OmmXnxzeGspJJgPr8r0yiYXXbwEtaIBmkT-KIZdE4Mg
VITE_APP_ENV=production
```

## Vercel Deployment Setup

### Step 1: Create Vercel Project

1. Go to [Vercel Dashboard](https://vercel.com/dashboard)
2. Click "Add New" â†’ "Project"
3. Import your Git repository
4. Configure:
   - **Project Name**: `classflow-staging`
   - **Framework Preset**: Vite
   - **Root Directory**: `./`
   - **Build Command**: `npm run build:staging`
   - **Output Directory**: `dist`

### Step 2: Configure Git Branches

**Staging Branch**:

- **Branch**: `staging`
- **Auto-Deploy**: Enabled
- **Environment**: Staging

**Production Branch** (Optional Mirror):

- **Branch**: `master`
- **Auto-Deploy**: Enabled
- **Environment**: Production Preview

### Step 3: Environment Variables (Auto-Read)

Vercel automatically reads environment variables from `.env.staging` during build. No manual configuration needed.

**Verification**:

```bash
# In Vercel build logs, you should see:
# âœ“ Loaded .env.staging
# âœ“ VITE_SUPABASE_URL: https://pnmzjmcfeekculqyirpr.supabase.co
```

## Hostinger Deployment Setup

### Step 1: Enable Git Integration

1. Log in to Hostinger hPanel
2. Navigate to your website
3. Go to **Git** section
4. Click "Connect to Git"

### Step 2: Configure Git Repository

1. **Repository URL**: Your Git repository (GitHub/GitLab)
2. **Branch**: `master`
3. **Deploy Path**: `/public_html` (or your web root)
4. **Build Command**: `npm run build:prod`
5. **Output Directory**: `dist`

### Step 3: Auto-Deploy Settings

- **Auto-Deploy**: Enabled
- **Trigger**: Push to `master` branch
- **Environment**: Production

**Build Process**:

```bash
# Hostinger auto-runs on push to main:
npm install
npm run build:prod  # Uses .env.production
# Copies dist/ to web root
```

## Rollback Strategy

### Emergency Rollback (Production)

**Option 1: Git Revert**

```bash
git revert <commit-hash>
git push origin main
# Hostinger auto-deploys reverted code
```

**Option 2: Database Rollback**

```bash
# Restore from backup
npm run backup:prod  # Should be run regularly
# Manually apply backup SQL if needed
```

**Option 3: Vercel Rollback (if using production mirror)**

- Go to Vercel Dashboard â†’ Deployments
- Find last stable deployment
- Click "Promote to Production"

## Best Practices

### 1. Migration Development

- âœ… Always test migrations in Development first
- âœ… Write reversible migrations (`ALTER` with `DROP` fallback)
- âœ… Include RLS policies in migration files
- âœ… Test with realistic data volumes in Staging

### 2. Environment Isolation

- âœ… Never point Production code to Dev/Staging databases
- âœ… Keep separate test accounts per environment
- âœ… Use environment indicators in UI (see Implementation section)

### 3. Backup Strategy

- âœ… Run `npm run backup:prod` before major migrations
- âœ… Store backups in `supabase/migrations/data_backups/`
- âœ… Test restoration process periodically

### 4. Monitoring

- âœ… Check Supabase Dashboard after deployments
- âœ… Monitor Vercel build logs for errors
- âœ… Verify RLS policies are applied correctly

## Troubleshooting

### Issue: Wrong Supabase Project Connected

**Symptom**: Data from wrong environment appearing in UI

**Solution**:

```bash
# Check current environment
console.log('Environment:', import.meta.env.VITE_APP_ENV)
console.log('Supabase URL:', import.meta.env.VITE_SUPABASE_URL)

# Verify .env file is correct
cat .env.development  # or .env.staging, .env.production
```

### Issue: Migration Not Applied

**Symptom**: New table/column not found

**Solution**:

```bash
# Manually apply migration
npx supabase db push --db-url "[connection-string]"

# Check migration history
npx supabase migration list
```

### Issue: Build Fails on Vercel/Hostinger

**Symptom**: "Module not found" or "Environment variable missing"

**Solution**:

1. Verify `.env.staging` or `.env.production` is committed
2. Check build command uses correct environment flag
3. Verify all dependencies are in `package.json` (not devDependencies)

## Environment Indicator (UI)

A small environment badge is displayed in development and staging builds:

**Location**: Bottom-right corner
**Appearance**:

- ğŸŸ¢ **DEV** (green badge) in development
- ğŸŸ¡ **STAGING** (yellow badge) in staging
- Hidden in production

**Implementation**: See `src/components/EnvironmentIndicator.tsx`

## Future Considerations

### Potential Enhancements

1. **CI/CD Pipeline**
   - GitHub Actions for automated testing
   - Automated migration validation
   - Slack notifications on deployment

2. **Database Seeding**
   - Seed scripts for Staging environment
   - Anonymized production data for testing

3. **Multiple Staging Environments**
   - Feature branches â†’ temporary Vercel previews
   - Isolated Supabase projects for large features

4. **Monitoring & Observability**
   - Sentry for error tracking
   - Supabase Analytics for query performance
   - Uptime monitoring (UptimeRobot, Pingdom)

## Implementation Status

### âœ… Completed (2025-01-19)

1. **Environment Files Created**
   - `.env.development` - Development Supabase (wkfgcroybuuefaulqsru)
   - `.env.staging` - Staging Supabase (pnmzjmcfeekculqyirpr)
   - `.env.production` - Production Supabase (dqsegqxnnhowqjxifhej)
   - **Root `.env` file deleted** - Was causing conflicts with environment-specific files
   - Added `.env` and `.env.local` to `.gitignore`

2. **Primary Supabase Client (`src/lib/supabase.ts`)**
   - Environment-aware client that dynamically selects correct project
   - Reads from `VITE_SUPABASE_URL` and `VITE_SUPABASE_ANON_KEY`
   - Logs environment info in development/staging for debugging

3. **Deprecated Client Migration**
   - Marked `src/integrations/supabase/client.ts` as deprecated
   - Migrated all imports to use `@/lib/supabase`:
     - âœ… `src/features/reports/pages/InstructorReportsPage.tsx`
     - âœ… `src/features/reports/services/instructorReportService.ts`
     - âœ… `src/features/reports/services/loadCalculationService.ts`
     - âœ… All other files (45+ files)

4. **Environment Validation (`src/lib/validateEnv.ts`)**
   - Validates required environment variables at startup
   - Logs environment info in non-production builds
   - Throws clear errors if configuration is missing

5. **Vite Configuration Updates (`vite.config.ts`)**
   - Explicitly loads environment files based on mode using `loadEnv(mode, process.cwd(), 'VITE_')`
   - Added console.log debugging to track environment loading
   - Defines env variables for `import.meta.env` via `define` block
   - Ensures correct environment selection during build

6. **Build Verification (`scripts/verify-build.js`)**
   - Enhanced post-build script to verify correct Supabase project ID
   - Shows detailed debugging output when wrong environment is detected
   - Lists which project IDs are found in the build
   - Provides clear troubleshooting steps
   - Prevents accidental deployment of wrong environment

7. **GitHub Actions Workflow (`.github/workflows/publish.yml`)**
   - Updated to use `npm run build:prod`
   - Added step to explicitly remove root `.env` file before building
   - Added build verification step
   - Ensures production builds use correct database

8. **Documentation Corrections**
   - Fixed environment mapping comments in `src/lib/supabase.ts`
   - Documented root `.env` file removal (auto-generated by Lovable)
   - Added troubleshooting section for common issues

### âš ï¸ Manual Steps Required

**Update `package.json` scripts** (file is read-only, needs manual edit):
```json
{
  "build:dev": "vite build --mode development && node scripts/verify-build.js development",
  "build:staging": "vite build --mode staging && node scripts/verify-build.js staging",
  "build:prod": "tsc -b && vite build --mode production && node scripts/verify-build.js production"
}
```

### ğŸ”„ Deployment Workflow

**Local Development (Lovable)**
```bash
npm run dev  # Uses .env.development â†’ wkfgcroybuuefaulqsru
```

**Staging Preview (Local)**
```bash
npm run build:staging
npm run preview:staging  # Uses .env.staging â†’ pnmzjmcfeekculqyirpr
```

**Production Preview (Local)**
```bash
npm run build:prod
npm run preview:prod  # Uses .env.production â†’ dqsegqxnnhowqjxifhej
```

**GitHub Actions â†’ Hostinger**
```bash
# Push to master branch
git push origin master

# GitHub Actions automatically:
# 1. Runs npm install
# 2. Runs npm run build:prod (uses .env.production)
# 3. Verifies build contains dqsegqxnnhowqjxifhej
# 4. Deploys dist/ to Hostinger
```

## Troubleshooting

### Build Verification Fails with Wrong Project ID

**Symptoms:**
```
âŒ Build verification failed!
Expected production to use project: dqsegqxnnhowqjxifhej
âš ï¸  Found development project ID instead: wkfgcroybuuefaulqsru
```

**Root Causes:**
1. Root `.env` file exists and overrides `.env.production`
2. Build cache contains old environment variables
3. Environment-specific file has incorrect values

**Solutions:**
1. Delete root `.env` file: `rm -f .env`
2. Clear build cache: `rm -rf dist node_modules/.vite`
3. Verify `.env.production` contains correct values
4. Rebuild: `npm run build:prod`

### Lovable Regenerates Root `.env` File

**Symptoms:**
Root `.env` file keeps appearing after deletion

**Solution:**
- The `.env` file is auto-generated by Lovable's integration
- It's already in `.gitignore` so it won't be committed
- GitHub Actions explicitly removes it before building
- For local builds, manually delete it before running `npm run build:prod`

### Timetable Loads Forever in Production Preview

**Symptoms:**
After running `npm run build:prod` and `npm run preview:prod`, the timetable never loads

**Root Causes:**
1. Build is connecting to wrong Supabase project
2. User session is stored in localStorage from previous environment

**Solutions:**
1. Verify build uses correct environment: `node scripts/verify-build.js production`
2. Clear browser localStorage/cookies and login again
3. Check browser console for Supabase connection errors
4. Verify `.env.production` has correct credentials

### Environment Variables Not Loading

**Symptoms:**
```
Missing required environment variables: VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY
```

**Root Causes:**
1. Environment-specific file doesn't exist
2. Variables not prefixed with `VITE_`
3. Build mode doesn't match environment file

**Solutions:**
1. Ensure `.env.production` exists with all required variables
2. Check all variables start with `VITE_` prefix
3. Run build with correct mode: `vite build --mode production`

## Conclusion

This multi-environment setup provides:

- âœ… Safe migration testing pipeline
- âœ… Isolated environments for each stage
- âœ… Simple, Git-based deployment workflow
- âœ… Production safety through Staging validation
- âœ… Build verification to prevent wrong environment deployments
- âœ… Environment validation at application startup
- âœ… Clear troubleshooting guidance for common issues

**Next Steps**:

1. âœ… Document plan (this file)
2. âœ… Create environment files
3. âœ… Update Supabase client
4. âœ… Migrate deprecated imports
5. â³ Manual update of `package.json` scripts (add verification to build commands)
6. â³ Set up Vercel project (optional for staging)
7. â³ Configure Hostinger Git integration
8. â³ Test full deployment pipeline end-to-end